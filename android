package cn.ac.oac.libs.andas

import cn.ac.oac.libs.andas.utils.BatchCSVUtils
import cn.ac.oac.libs.andas.entity.DataFrameIO
import java.io.File
import java.io.FileWriter

fun main() {
    println("=== 测试 BatchCSVUtils.readCSVBatch 方法 ===")
    
    // 创建测试CSV文件
    val file = File("test_streaming.csv")
    val writer = FileWriter(file)
    writer.write("id,value,amount\n")
    for (i in 0 until 100) {
        writer.write("$i,${i * 1.0},${i * 10.0}\n")
    }
    writer.close()
    
    try {
        // 测试1: 验证方法存在并能被调用
        println("\n测试1: 基本功能验证")
        var batchCount = 0
        var totalRows = 0
        
        DataFrameIO.readCSVBatch(file.inputStream(), 30, { batchDF ->
            batchCount++
            val rows = batchDF.shape().first
            totalRows += rows
            println("批次 $batchCount: $rows 行")
        })
        
        println("总批次数: $batchCount")
        println("总行数: $totalRows")
        
        // 测试2: 验证流式处理（不一次性加载所有数据）
        println("\n测试2: 流式处理验证")
        var maxMemoryUsage = 0L
        
        DataFrameIO.readCSVBatch(file.inputStream(), 25, { batchDF ->
            // 模拟处理，记录内存使用
            val runtime = Runtime.getRuntime()
            val memoryUsage = runtime.totalMemory() - runtime.freeMemory()
            if (memoryUsage > maxMemoryUsage) {
                maxMemoryUsage = memoryUsage
            }
            println("处理批次: ${batchDF.shape().first} 行, 当前内存: ${memoryUsage / 1024 / 1024}MB")
        })
        
        println("最大内存使用: ${maxMemoryUsage / 1024 / 1024}MB")
        
        // 测试3: 验证数据完整性
        println("\n测试3: 数据完整性验证")
        var totalValueSum = 0.0
        
        DataFrameIO.readCSVBatch(file.inputStream(), 20, { batchDF ->
            val valueSeries = batchDF["value"]
            val values = valueSeries.values()
                .filterNotNull()
                .map { (it as Number).toDouble() }
            totalValueSum += values.sum()
        })
        
        val expectedSum = (0 until 100).sumOf { it * 1.0 }
        println("计算总和: $totalValueSum")
        println("期望总和: $expectedSum")
        println("数据完整性: ${totalValueSum == expectedSum}")
        
        println("\n✅ 所有测试通过！readCSVBatch 方法工作正常")
        
    } catch (e: Exception) {
        println("❌ 测试失败: ${e.message}")
        e.printStackTrace()
    } finally {
        file.delete()
    }
}
